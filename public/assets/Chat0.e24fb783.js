import{f as e,g as t,j as s,E as o,F as a,k as r,G as n,z as i,A as m,o as l,l as c}from"./index.154289d4.js";import{_ as d}from"./stage2.41e6de3a.js";const u={props:{item:Object,view:String},setup(e){const t=computed((()=>{let t=e.item;for(;;){if(!t)return null;if("Project"===t.type)return t;if(t.connections&&t.connections.project)return t.c.project;if(t.conn&&t.conn.project)return ecs.root[t.conn.project];if(!t.located||!t.located.rel)return null;t=t.located.rel}})),s=computed((()=>t.value?ecs.findOne((e=>"MessageBase0"===e.type&&e.located.rel===t.value.id)):null)),o=ecs.by((t=>"Msg0"===t.type&&t.conn.rel===e.item.id),{sort:(e,t)=>!e.msg0vtm.dtCreated&&t.msg0vtm.dtCreated?-1:e.msg0vtm.dtCreated&&!t.msg0vtm.dtCreated?1:t.msg0vtm.dtCreated-e.msg0vtm.dtCreated}),a=computed((()=>ecs.root.useID.slot0.entity)),r=computed((()=>{const t=s.value;if(!t)return core.log(`${pure.itemToken(e.item)} No messagebase => No new message.`),null;if(!a.value)return core.log(`${pure.itemToken(e.item)} No identity => No new message.`),null;if(t.messageBase0.newMessages[e.item.id])return core.log(`${pure.itemToken(e.item)} New message already present.`),ecs.root[t.messageBase0.newMessages[e.item.id]];const o=ecs.create("Msg0",{conn:{from:a.value?a.value.id:null,to:"all",rel:e.item.id},located:{rel:t.id}});return t.messageBase0.newMessages[e.item.id]=o.id,ecs.addComponent(o,ecs.compo.timer()),o}));return onMounted((async()=>{for(s.value||core.log(`${pure.itemToken(e.item)} [Require MessageBase0].`);!s.value;)await core.ms(50);for(core.log(`${pure.itemToken(e.item)} MessageBase Up.`),a.value||core.log(`${pure.itemToken(e.item)} [Require Identity].`);!a.value;)await core.ms(50);return core.log(`${pure.itemToken(e.item)} Identity Up.`),core.yehat.ex({cmd:"msg0.join",rel:e.item.id,messageBaseID:s.value.id,memberCardID:a.value.id}).then((({code:t,details:s,messages:o})=>{"ok"===t?o&&o.length&&ecs.boot(o):core.log(`${pure.itemToken(e.item)} [!] Cannot join chat.`,s)})),r.value})),onBeforeUnmount((()=>{core.yehat.ex({cmd:"msg0.leave",rel:e.item.id}).then((e=>console.log("chat leave =>",e)))})),{project:t,messageBase:s,msgs:o,newMessage:r,identity:a,done:t=>{const o=s.value;t.id===r.value.id&&delete o.messageBase0.newMessages[e.item.id],ecs.root[t.id]&&(ecs.root[t.id].timer&&ecs.root[t.id].timer.stop(),delete ecs.root[t.id]),Quasar.Notify.create(`${pure.itemToken(e.item)} [+] Msg0`)}}}};i("data-v-6c5ea546");const g={key:0,class:"chat-0 column no-wrap"},p={class:"msg-roll col scroll"},v={key:1,class:"chat-0-counter"},f=s("i",null,null,-1),y={key:2};m();var w=d(u,[["render",function(i,m,d,u,w,M){const k=e("Msg0");return"base"===d.view?(l(),t("div",g,[s("header",null,"Chat MK 0 "+o(u.identity?u.identity.memberCard0.name:"guest"),1),s("div",p,[(l(!0),t(a,null,r(u.msgs,((e,t)=>(l(),c(k,{key:t,item:e,edit:u.newMessage&&e.id===u.newMessage.id,onDone:t=>u.done(e)},null,8,["item","edit","onDone"])))),128))])])):"counter"===d.view?(l(),t("div",v,[f,n(" "+o(u.msgs.length),1)])):(l(),t("div",y))}],["__scopeId","data-v-6c5ea546"]]);export{w as default};
